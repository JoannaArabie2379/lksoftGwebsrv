{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - –ò–ì–° –ü–æ—Ä—Ç–∞–ª{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –°–∏—Å—Ç–µ–º–∞</p>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üîµ</div>
            <div class="stat-info">
                <span class="stat-value" id="stat-wells">-</span>
                <span class="stat-label">–ö–æ–ª–æ–¥—Ü—ã</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìç</div>
            <div class="stat-info">
                <span class="stat-value" id="stat-markers">-</span>
                <span class="stat-label">–£–∫–∞–∑. —Å—Ç–æ–ª–±–∏–∫–∏</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚û°Ô∏è</div>
            <div class="stat-info">
                <span class="stat-value" id="stat-directions">-</span>
                <span class="stat-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üîå</div>
            <div class="stat-info">
                <span class="stat-value" id="stat-cables">-</span>
                <span class="stat-label">–ö–∞–±–µ–ª–∏</span>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="section">
        <h2>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        <div class="action-grid">
            <a href="{{ url_for('map_view') }}" class="action-card">
                <span class="action-icon">üó∫Ô∏è</span>
                <span class="action-title">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</span>
                <span class="action-desc">–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ</span>
            </a>
            
            {% if not current_user.is_viewer() %}
            <button class="action-card" onclick="showAddObjectModal()">
                <span class="action-icon">‚ûï</span>
                <span class="action-title">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</span>
                <span class="action-desc">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞</span>
            </button>
            
            <button class="action-card" onclick="showImportModal()">
                <span class="action-icon">üì•</span>
                <span class="action-title">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                <span class="action-desc">–ò–º–ø–æ—Ä—Ç –∏–∑ CSV/TAB</span>
            </button>
            {% endif %}
            
            {% if current_user.is_admin() %}
            <button class="action-card" onclick="openAdminPanel()">
                <span class="action-icon">‚öôÔ∏è</span>
                <span class="action-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                <span class="action-desc">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</span>
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Objects List Section -->
    <div class="section">
        <div class="section-header">
            <h2>–û–±—ä–µ–∫—Ç—ã —Å–∏—Å—Ç–µ–º—ã</h2>
            <div class="section-actions">
                <select id="object-type-select" onchange="loadObjects()">
                    <option value="wells">–ö–æ–ª–æ–¥—Ü—ã</option>
                    <option value="marker_posts">–£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±–∏–∫–∏</option>
                    <option value="channel_directions">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤</option>
                    <option value="ground_cables">–ö–∞–±–µ–ª—å –≤ –≥—Ä—É–Ω—Ç–µ</option>
                    <option value="aerial_cables">–í–æ–∑–¥—É—à–Ω—ã–µ –∫–∞–±–µ–ª–∏</option>
                    <option value="duct_cables">–ö–∞–±–µ–ª—å –≤ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏</option>
                </select>
            </div>
        </div>
        
        <div class="table-container">
            <table class="data-table" id="objects-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–æ–º–µ—Ä</th>
                        <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
                        <th>–°–æ–∑–¥–∞–Ω</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="objects-tbody">
                    <tr>
                        <td colspan="5" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Object Modal -->
<div class="modal" id="add-object-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</h3>
            <button class="modal-close" onclick="closeModal('add-object-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="add-object-form" onsubmit="submitNewObject(event)">
                <div class="form-group">
                    <label>–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞</label>
                    <select name="object_type" id="new-object-type" onchange="updateObjectForm()">
                        <option value="wells">–ö–æ–ª–æ–¥–µ—Ü</option>
                        <option value="marker_posts">–£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–∏–∫</option>
                        <option value="channel_directions">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</option>
                        <option value="ground_cables">–ö–∞–±–µ–ª—å –≤ –≥—Ä—É–Ω—Ç–µ</option>
                        <option value="aerial_cables">–í–æ–∑–¥—É—à–Ω—ã–π –∫–∞–±–µ–ª—å</option>
                        <option value="duct_cables">–ö–∞–±–µ–ª—å –≤ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä *</label>
                    <input type="text" name="number" required>
                </div>
                
                <div class="form-row" id="point-coords">
                    <div class="form-group">
                        <label>–®–∏—Ä–æ—Ç–∞ (WGS84)</label>
                        <input type="number" name="lat" step="any" placeholder="61.0000">
                    </div>
                    <div class="form-group">
                        <label>–î–æ–ª–≥–æ—Ç–∞ (WGS84)</label>
                        <input type="number" name="lon" step="any" placeholder="73.0000">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫</label>
                    <select name="owner_id" id="owner-select">
                        <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>
                    </select>
                </div>
                
                <div class="form-group" id="well-type-group">
                    <label>–¢–∏–ø –∫–æ–ª–æ–¥—Ü–∞</label>
                    <select name="well_type_id" id="well-type-select">
                        <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                    <select name="state_id" id="state-select">
                        <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-object-modal')">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal" id="import-modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            <button class="modal-close" onclick="closeModal('import-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="import-tabs">
                <button class="tab-btn active" onclick="switchImportTab('csv')">CSV</button>
                <button class="tab-btn" onclick="switchImportTab('tab')">TAB/MAP/DAT</button>
            </div>
            
            <div id="csv-import" class="import-content active">
                <form id="csv-import-form" onsubmit="submitCSVImport(event)">
                    <div class="form-group">
                        <label>–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞</label>
                        <select name="object_type" required>
                            <option value="wells">–ö–æ–ª–æ–¥—Ü—ã</option>
                            <option value="marker_posts">–£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±–∏–∫–∏</option>
                            <option value="ground_cables">–ö–∞–±–µ–ª–∏ –≤ –≥—Ä—É–Ω—Ç–µ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>CSV —Ñ–∞–π–ª</label>
                        <input type="file" name="file" accept=".csv" required onchange="previewCSV(this)">
                    </div>
                    
                    <div id="csv-preview" class="csv-preview hidden">
                        <h4>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫</h4>
                        <div id="csv-mapping"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('import-modal')">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </form>
            </div>
            
            <div id="tab-import" class="import-content">
                <form id="tab-import-form" onsubmit="submitTABImport(event)">
                    <div class="form-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–ª–µ–∫—Ç —Ñ–∞–π–ª–æ–≤ (TAB, DAT, MAP, ID)</label>
                        <input type="file" name="files" multiple accept=".tab,.dat,.map,.id" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('import-modal')">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Admin Panel Modal -->
<div class="modal" id="admin-modal">
    <div class="modal-content modal-xl">
        <div class="modal-header">
            <h3>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <button class="modal-close" onclick="closeModal('admin-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchAdminTab('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button class="tab-btn" onclick="switchAdminTab('owners')">–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏</button>
                <button class="tab-btn" onclick="switchAdminTab('contracts')">–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã</button>
                <button class="tab-btn" onclick="switchAdminTab('references')">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</button>
            </div>
            
            <div id="admin-users" class="admin-content active">
                <div class="admin-toolbar">
                    <button class="btn btn-primary" onclick="showAddUserModal()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–õ–æ–≥–∏–Ω</th>
                            <th>–§–ò–û</th>
                            <th>–†–æ–ª—å</th>
                            <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody"></tbody>
                </table>
            </div>
            
            <div id="admin-owners" class="admin-content">
                <div class="admin-toolbar">
                    <button class="btn btn-primary" onclick="showAddOwnerModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                            <th>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody id="owners-tbody"></tbody>
                </table>
            </div>
            
            <div id="admin-contracts" class="admin-content">
                <div class="admin-toolbar">
                    <button class="btn btn-primary" onclick="showAddContractModal()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–æ–º–µ—Ä</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫</th>
                        </tr>
                    </thead>
                    <tbody id="contracts-tbody"></tbody>
                </table>
            </div>
            
            <div id="admin-references" class="admin-content">
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏ —Ç–∏–ø–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤</p>
                <!-- Reference tables management -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Load statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadObjects();
    loadReferences();
});

async function loadStats() {
    try {
        const response = await fetch('/api/stats');
        const stats = await response.json();
        
        document.getElementById('stat-wells').textContent = stats.wells || 0;
        document.getElementById('stat-markers').textContent = stats.marker_posts || 0;
        document.getElementById('stat-directions').textContent = stats.channel_directions || 0;
        document.getElementById('stat-cables').textContent = 
            (stats.ground_cables || 0) + (stats.aerial_cables || 0) + (stats.duct_cables || 0);
    } catch (e) {
        console.error('Error loading stats:', e);
    }
}

async function loadObjects() {
    const objectType = document.getElementById('object-type-select').value;
    const tbody = document.getElementById('objects-tbody');
    
    try {
        const response = await fetch(`/api/objects/${objectType}`);
        const objects = await response.json();
        
        if (objects.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }
        
        tbody.innerHTML = objects.map(obj => `
            <tr>
                <td>${obj.id}</td>
                <td>${obj.number || '-'}</td>
                <td>${obj.state_name || '-'}</td>
                <td>${new Date(obj.created_at).toLocaleDateString('ru-RU')}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="viewObject('${objectType}', ${obj.id})">üëÅÔ∏è</button>
                    <button class="btn btn-sm btn-secondary" onclick="editObject('${objectType}', ${obj.id})">‚úèÔ∏è</button>
                </td>
            </tr>
        `).join('');
    } catch (e) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    }
}

async function loadReferences() {
    // Load owners
    try {
        const ownersRes = await fetch('/api/owners');
        const owners = await ownersRes.json();
        const ownerSelect = document.getElementById('owner-select');
        ownerSelect.innerHTML = '<option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>' + 
            owners.map(o => `<option value="${o.id}">${o.organization_name}</option>`).join('');
    } catch (e) {}
    
    // Load states
    try {
        const statesRes = await fetch('/api/references/object_states');
        const states = await statesRes.json();
        const stateSelect = document.getElementById('state-select');
        stateSelect.innerHTML = '<option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>' + 
            states.map(s => `<option value="${s.id}">${s.description || s.name}</option>`).join('');
    } catch (e) {}
    
    // Load well types
    try {
        const typesRes = await fetch('/api/references/well_types');
        const types = await typesRes.json();
        const typeSelect = document.getElementById('well-type-select');
        typeSelect.innerHTML = '<option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>' + 
            types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    } catch (e) {}
}

function showAddObjectModal() {
    document.getElementById('add-object-modal').classList.add('show');
    updateObjectForm();
}

function updateObjectForm() {
    const type = document.getElementById('new-object-type').value;
    const wellTypeGroup = document.getElementById('well-type-group');
    const pointCoords = document.getElementById('point-coords');
    
    // Show/hide well type selector
    wellTypeGroup.style.display = type === 'wells' ? 'block' : 'none';
    
    // Show/hide point coordinates (for points only)
    const isPoint = ['wells', 'marker_posts'].includes(type);
    pointCoords.style.display = isPoint ? 'flex' : 'none';
}

async function submitNewObject(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const objectType = formData.get('object_type');
    
    const data = {};
    formData.forEach((value, key) => {
        if (key !== 'object_type' && value) {
            data[key] = value;
        }
    });
    
    try {
        const response = await fetch(`/api/objects/${objectType}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification('–û–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω', 'success');
            closeModal('add-object-modal');
            form.reset();
            loadObjects();
            loadStats();
        } else {
            showNotification(result.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è', 'error');
        }
    } catch (e) {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

function showImportModal() {
    document.getElementById('import-modal').classList.add('show');
}

function switchImportTab(tab) {
    document.querySelectorAll('.import-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.import-tabs .tab-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById(tab + '-import').classList.add('active');
    event.target.classList.add('active');
}

function openAdminPanel() {
    document.getElementById('admin-modal').classList.add('show');
    loadAdminData();
}

function switchAdminTab(tab) {
    document.querySelectorAll('.admin-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.admin-tabs .tab-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById('admin-' + tab).classList.add('active');
    event.target.classList.add('active');
}

async function loadAdminData() {
    // Load users
    try {
        const res = await fetch('/api/users');
        const users = await res.json();
        document.getElementById('users-tbody').innerHTML = users.map(u => `
            <tr>
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td>${u.full_name || '-'}</td>
                <td>${u.role_name}</td>
                <td>${u.is_active ? '‚úÖ' : '‚ùå'}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="editUser(${u.id})">‚úèÔ∏è</button>
                </td>
            </tr>
        `).join('');
    } catch (e) {}
    
    // Load owners
    try {
        const res = await fetch('/api/owners');
        const owners = await res.json();
        document.getElementById('owners-tbody').innerHTML = owners.map(o => `
            <tr>
                <td>${o.id}</td>
                <td>${o.organization_name}</td>
                <td>${o.contact_person || '-'}</td>
                <td>${o.phone || '-'}</td>
                <td>${o.email || '-'}</td>
            </tr>
        `).join('');
    } catch (e) {}
    
    // Load contracts
    try {
        const res = await fetch('/api/contracts');
        const contracts = await res.json();
        document.getElementById('contracts-tbody').innerHTML = contracts.map(c => `
            <tr>
                <td>${c.id}</td>
                <td>${c.contract_number}</td>
                <td>${c.contract_date}</td>
                <td>${c.owner_name || '-'}</td>
            </tr>
        `).join('');
    } catch (e) {}
}

function viewObject(type, id) {
    window.location.href = `/map?layer=${type}&id=${id}`;
}

function editObject(type, id) {
    // Open edit modal
    console.log('Edit:', type, id);
}
</script>
{% endblock %}
