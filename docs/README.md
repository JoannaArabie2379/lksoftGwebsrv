# ИГС lksoftGwebsrv

## Информационная географическая система

Версия: 1.0.0

---

## Содержание

1. [Описание системы](#описание-системы)
2. [Требования](#требования)
3. [Установка](#установка)
4. [Архитектура](#архитектура)
5. [API документация](#api-документация)
6. [Руководство пользователя](#руководство-пользователя)
7. [Администрирование](#администрирование)

---

## Описание системы

ИГС lksoftGwebsrv — это web-портал информационной географической системы для управления объектами кабельной инфраструктуры:

- Колодцы кабельной канализации
- Направления и каналы кабельной канализации
- Указательные столбики
- Кабели (в грунте, воздушные, в канализации)
- Инциденты и их история
- Группы объектов

### Основные возможности

- Интерактивная карта с отображением объектов
- Поддержка двух систем координат: WGS84 (EPSG:4326) и МСК86 Зона 4
- Фильтрация объектов по типу, состоянию, собственнику, контракту
- Управление слоями карты
- Импорт данных из CSV и MapInfo
- Экспорт отчётов
- Управление справочниками
- Система авторизации с ролями

---

## Требования

### Серверные требования

- **Web-сервер**: Apache 2.4+ с mod_rewrite
- **PHP**: 8.0+
- **PostgreSQL**: 13+ с расширением PostGIS 3.0+
- **Расширения PHP**:
  - pdo_pgsql
  - json
  - mbstring
  - gd (для обработки изображений)

### Клиентские требования

- Современный браузер (Chrome, Firefox, Edge, Safari)
- JavaScript включён
- Разрешение экрана: минимум 1024x768 (рекомендуется 1920x1080)

---

## Установка

### 1. Клонирование репозитория

```bash
cd /var/www/html
git clone <repository_url> lksoftGwebsrv
```

### 2. Настройка базы данных

Подключитесь к PostgreSQL и создайте базу данных:

```sql
CREATE DATABASE lksoftgwebsrv;
CREATE USER lksoftgwebsrv WITH PASSWORD 'lksoftGwebsrv';
GRANT ALL PRIVILEGES ON DATABASE lksoftgwebsrv TO lksoftgwebsrv;
```

Включите PostGIS:

```sql
\c lksoftgwebsrv
CREATE EXTENSION postgis;
```

Выполните скрипт создания схемы:

```bash
psql -h 10.16.10.150 -U lksoftgwebsrv -d lksoftgwebsrv -f database/schema.sql
```

### 3. Настройка конфигурации

Отредактируйте файл `config/database.php`:

```php
return [
    'host' => '10.16.10.150',
    'port' => '5432',
    'dbname' => 'lksoftgwebsrv',
    'user' => 'lksoftgwebsrv',
    'password' => 'lksoftGwebsrv',
];
```

### 4. Настройка Apache

Убедитесь, что mod_rewrite включён:

```bash
a2enmod rewrite
systemctl restart apache2
```

### 5. Права доступа

```bash
chown -R www-data:www-data /var/www/html/lksoftGwebsrv
chmod -R 755 /var/www/html/lksoftGwebsrv
chmod -R 777 /var/www/html/lksoftGwebsrv/uploads
```

### 6. Первый вход

Откройте в браузере: `http://your-server/lksoftGwebsrv/`

Данные для входа:
- **Логин**: `root`
- **Пароль**: `Kolobaha00!`

---

## Архитектура

### Структура проекта

```
lksoftGwebsrv/
├── api/
│   └── index.php          # Точка входа API
├── assets/
│   ├── css/
│   │   └── style.css      # Стили приложения
│   └── js/
│       ├── api.js         # API клиент
│       ├── app.js         # Основное приложение
│       └── map.js         # Управление картой
├── config/
│   ├── app.php            # Конфигурация приложения
│   └── database.php       # Конфигурация БД
├── database/
│   └── schema.sql         # DDL схема БД
├── docs/
│   └── README.md          # Документация
├── src/
│   ├── Controllers/       # Контроллеры API
│   └── Core/              # Ядро приложения
├── uploads/               # Загруженные файлы
├── vendor/
│   └── autoload.php       # Автозагрузчик
├── .htaccess              # Конфигурация Apache
└── index.html             # Главная страница
```

### Технологический стек

**Backend:**
- PHP 8+ (чистая архитектура)
- PostgreSQL с PostGIS
- RESTful API

**Frontend:**
- HTML5 / CSS3
- Vanilla JavaScript (ES6+)
- Leaflet.js для карты
- Font Awesome для иконок

### База данных

Основные таблицы:
- `users`, `roles` — пользователи и роли
- `object_types`, `object_kinds`, `object_status` — справочники типов
- `owners`, `contracts` — собственники и контракты
- `wells` — колодцы кабельной канализации
- `channel_directions`, `cable_channels` — направления и каналы
- `marker_posts` — указательные столбики
- `ground_cables`, `aerial_cables`, `duct_cables` — кабели
- `incidents`, `incident_history` — инциденты
- `object_groups` — группы объектов
- `object_photos` — фотографии

---

## API документация

### Авторизация

Все запросы к API (кроме `/api/auth/login`) требуют токен авторизации:

```
Authorization: Bearer <token>
```

#### POST /api/auth/login

Авторизация пользователя.

**Запрос:**
```json
{
    "login": "root",
    "password": "Kolobaha00!"
}
```

**Ответ:**
```json
{
    "success": true,
    "data": {
        "user": {
            "id": 1,
            "login": "root",
            "role": {"code": "admin", "name": "Администратор"}
        },
        "token": "abc123..."
    }
}
```

### Справочники

#### GET /api/references/{type}

Получение списка записей справочника.

Типы: `object_types`, `object_kinds`, `object_status`, `owners`, `contracts`

#### POST /api/references/{type}

Создание записи справочника.

#### PUT /api/references/{type}/{id}

Обновление записи справочника.

#### DELETE /api/references/{type}/{id}

Удаление записи справочника.

### Колодцы

#### GET /api/wells

Список колодцев с пагинацией.

**Параметры:**
- `page` — номер страницы
- `limit` — количество записей
- `search` — поиск по номеру
- `owner_id` — фильтр по собственнику
- `status_id` — фильтр по состоянию

#### GET /api/wells/geojson

GeoJSON всех колодцев для карты.

#### GET /api/wells/{id}

Получение колодца по ID.

#### POST /api/wells

Создание колодца.

**Запрос:**
```json
{
    "number": "КК-001",
    "latitude": 55.751244,
    "longitude": 37.618423,
    "owner_id": 1,
    "type_id": 1,
    "kind_id": 1,
    "status_id": 1
}
```

#### PUT /api/wells/{id}

Обновление колодца.

#### DELETE /api/wells/{id}

Удаление колодца.

### Кабели

#### GET /api/cables/{type}

Список кабелей. Типы: `ground`, `aerial`, `duct`

#### GET /api/cables/{type}/geojson

GeoJSON кабелей.

#### GET /api/cables/all/geojson

GeoJSON всех кабелей.

### Инциденты

#### GET /api/incidents

Список инцидентов.

#### POST /api/incidents

Создание инцидента.

#### POST /api/incidents/{id}/history

Добавление записи в историю инцидента.

### Отчёты

#### GET /api/reports/objects

Отчёт по объектам.

#### GET /api/reports/contracts

Отчёт по контрактам.

#### GET /api/reports/owners

Отчёт по собственникам.

#### GET /api/reports/export/{type}

Экспорт отчёта в CSV.

---

## Руководство пользователя

### Авторизация

1. Откройте систему в браузере
2. Введите логин и пароль
3. Нажмите "Войти"

### Работа с картой

**Слои:**
- Включайте/выключайте слои в боковой панели
- Каждый тип объектов имеет свой цвет

**Фильтры:**
- Выберите собственника, состояние или контракт
- Нажмите "Применить"

**Информация об объекте:**
- Кликните на объект на карте
- В правой панели появится информация

**Системы координат:**
- WGS84 — с подложкой OpenStreetMap
- МСК86 — без подложки (локальная система)

### Работа с объектами

1. Перейдите в раздел "Объекты"
2. Выберите тип объектов (табы)
3. Используйте поиск и пагинацию
4. Для добавления нажмите "Добавить"
5. Для редактирования нажмите иконку карандаша

### Импорт данных

1. Нажмите "Импорт" в разделе "Объекты"
2. Выберите тип объекта и файл CSV
3. Укажите систему координат
4. Нажмите "Предпросмотр"
5. Подтвердите импорт

### Инциденты

1. Перейдите в раздел "Инциденты"
2. Для создания нажмите "Создать инцидент"
3. Заполните форму
4. Связывайте инциденты с объектами

### Отчёты

1. Перейдите в раздел "Отчёты"
2. Выберите тип отчёта
3. Для экспорта нажмите "Экспорт CSV"

---

## Администрирование

### Управление пользователями

Доступно только администраторам.

1. Перейдите в раздел "Админ"
2. Для добавления пользователя нажмите "Добавить пользователя"
3. Укажите логин, пароль и роль

### Роли

- **Администратор** — полный доступ
- **Пользователь** — просмотр и редактирование
- **Только чтение** — только просмотр

### Справочники

Справочники редактируются в разделе "Справочники":

- Виды объектов
- Типы объектов
- Состояния
- Собственники
- Контракты
- Стили отображения

### Резервное копирование

Рекомендуется регулярно создавать резервные копии базы данных:

```bash
pg_dump -h 10.16.10.150 -U lksoftgwebsrv -d lksoftgwebsrv > backup_$(date +%Y%m%d).sql
```

---

## Поддержка

При возникновении вопросов обращайтесь к администратору системы.

---

© 2024 lksoftGwebsrv. Все права защищены.
