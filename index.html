<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ИГС lksoftGwebsrv</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <link rel="icon" href="assets/favicon.svg" />

    <!-- Custom CSS (версия для сброса кеша) -->
    <link rel="stylesheet" href="assets/css/style.css?v=2.2.0" />
</head>
<body class="theme-dark">
    <!-- Экран загрузки -->
    <div id="loading-screen">
        <div class="loader">
            <i class="fas fa-globe fa-spin"></i>
            <p>Загрузка ИГС...</p>
        </div>
    </div>

    <!-- Экран авторизации -->
    <div id="login-screen" class="hidden">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-map-marked-alt"></i>
                <h1>ИГС lksoftGwebsrv</h1>
                <p>Информационная географическая система</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login">Логин</label>
                    <input type="text" id="login" name="login" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Пароль</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Войти
                </button>
                <div id="login-error" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <!-- Основное приложение -->
    <div id="app" class="hidden">
        <!-- Верхняя панель -->
        <header class="top-bar">
            <button id="btn-mobile-menu" class="btn btn-sm mobile-menu-btn" title="Меню">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-map-marked-alt"></i>
                <span>ИГС lksoftGwebsrv</span>
            </div>
            <div class="top-bar-actions">
                <div class="coordinate-system-toggle">
                    <button id="btn-wgs84" class="btn btn-sm active" title="WGS84 (EPSG:4326)">WGS84</button>
                    <button id="btn-ruler" class="btn btn-sm" title="Линейка">
                        <i class="fas fa-ruler"></i>
                    </button>
                    <button id="btn-toggle-wmts" class="btn btn-sm" title="Спутник (WMTS)">
                        <i class="fas fa-layer-group"></i>
                    </button>
                </div>
                <div class="theme-toggle">
                    <button id="btn-theme-dark" class="btn btn-sm active" title="Тёмная тема">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="btn-theme-grey" class="btn btn-sm" title="Серая тема">
                        <i class="fas fa-adjust"></i>
                    </button>
                </div>
                <div class="user-menu">
                    <span id="user-name"></span>
                    <a id="btn-instruction" class="btn btn-sm" href="instructions.html" target="_blank" rel="noopener" title="Инструкция">
                        <i class="fas fa-circle-info"></i>
                    </a>
                    <button id="btn-logout" class="btn btn-sm" title="Выход">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Оверлей для мобильного меню -->
        <div id="sidebar-overlay" class="sidebar-overlay hidden"></div>

        <div class="main-container">
            <!-- Боковая панель -->
            <aside class="sidebar">
                <div id="sidebar-resizer" class="sidebar-resizer" title="Изменить ширину панели"></div>
                <nav class="sidebar-nav">
                    <button class="nav-item active" data-panel="map">
                        <i class="fas fa-map"></i>
                        <span>Карта</span>
                    </button>
                    <button class="nav-item" data-panel="objects">
                        <i class="fas fa-database"></i>
                        <span>Объекты</span>
                    </button>
                    <button class="nav-item" data-panel="incidents">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Инциденты</span>
                    </button>
                    <button class="nav-item" data-panel="contracts">
                        <i class="fas fa-file-contract"></i>
                        <span>Контракты</span>
                    </button>
                    <button class="nav-item" data-panel="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Отчёты</span>
                    </button>
                    <button class="nav-item" data-panel="references">
                        <i class="fas fa-book"></i>
                        <span>Справочники</span>
                    </button>
                    <button class="nav-item admin-only" data-panel="admin">
                        <i class="fas fa-cog"></i>
                        <span>Админ</span>
                    </button>
                    <button class="nav-item" data-panel="settings">
                        <i class="fas fa-sliders-h"></i>
                        <span>Настройки</span>
                    </button>
                </nav>

                <!-- Панель слоёв -->
                <div class="sidebar-panel" id="panel-layers">
                    <div class="sidebar-panel-main">
                    <h3><i class="fas fa-layer-group"></i> Слои</h3>
                    <div class="layers-list">
                        <label class="layer-item">
                            <input type="checkbox" id="layer-wells" checked>
                            <span class="layer-icon" style="background: #fa00fa;"></span>
                            <span class="layer-title">Колодцы</span>
                            <span class="layer-inline-controls" id="wells-inline-controls">
                                <button type="button" class="layer-inline-btn" id="btn-toggle-well-labels" title="Подсказки (номера колодцев)">
                                    <i class="fas fa-tag"></i>
                                </button>
                                <button type="button" class="layer-inline-btn" id="btn-toggle-object-coordinates" title="Показать координаты">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                            </span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-channels" checked>
                            <span class="layer-icon" style="background: #fa00fa;"></span>
                            <span class="layer-title">Направления каналов</span>
                            <span class="layer-inline-controls">
                                <button type="button" class="layer-inline-btn" id="btn-toggle-direction-length-labels" title="Подсказки длина направления">
                                    <i class="fas fa-ruler-horizontal"></i>
                                </button>
                            </span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-inventory">
                            <span class="layer-icon" style="background: #6b7280;"></span>
                            <span class="layer-title">Инвентаризация</span>
                            <button type="button" class="layer-inline-btn hidden active" id="btn-inventory-unacc-labels" title="Подсказки: неучтенные кабели (вкл/выкл)">
                                <i class="fas fa-tag"></i>
                            </button>
                        </label>
                        <label class="layer-item layer-item-wrap">
                            <input type="checkbox" id="layer-assumed-cables">
                            <span class="layer-icon" style="background: #a855f7;"></span>
                            <span class="layer-title layer-title-wrap">Предполагаемые кабели</span>
                            <span class="layer-inline-controls hidden" id="assumed-cables-controls">
                                <select id="assumed-cables-variant" class="layer-inline-select" title="Вариант расчёта (1/2/3)">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                                <button type="button" class="layer-inline-btn" id="btn-assumed-cables-rebuild" title="Пересчитать предполагаемые кабели">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-markers" checked>
                            <span class="layer-icon" style="background: #e67e22;"></span>
                            <span>Столбики</span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-ground-cables">
                            <span class="layer-icon" style="background: #551b1b;"></span>
                            <span>Кабели в грунте</span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-aerial-cables">
                            <span class="layer-icon" style="background: #009dff;"></span>
                            <span>Воздушные кабели</span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-duct-cables">
                            <span class="layer-icon" style="background: #00bd26;"></span>
                            <span>Кабели в канализации</span>
                        </label>
                    </div>

                    <h3><i class="fas fa-filter"></i> Фильтры</h3>
                    <div class="filters-panel">
                        <div class="form-group">
                            <label>ТУ</label>
                            <select id="filter-group">
                                <option value="">Все объекты</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Собственник</label>
                            <select id="filter-owner">
                                <option value="">Все</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Состояние</label>
                            <select id="filter-status">
                                <option value="">Все</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Контракт</label>
                            <select id="filter-contract">
                                <option value="">Все</option>
                            </select>
                        </div>
                        <button id="btn-reset-filters" class="btn btn-secondary btn-block">
                            <i class="fas fa-times"></i> Сбросить
                        </button>
                    </div>
                    </div>

                    <div class="sidebar-panel-links">
                        <h3><i class="fas fa-external-link-alt"></i> Ссылки</h3>
                        <div class="filters-panel">
                            <a class="btn btn-secondary btn-block" id="link-geoproj" href="https://wgs-msk.soilbox.app/" target="_blank" rel="noopener noreferrer">
                                <i class="fas fa-ruler-combined"></i> Ресурс для пересчёта координат
                            </a>
                            <a class="btn btn-secondary btn-block" id="link-cadastre" href="https://nspd.gov.ru/map?zoom=16.801685060501118&theme_id=1&coordinate_x=8535755.537972113&coordinate_y=9908336.650357058&baseLayerId=235&is_copy_url=true" target="_blank" rel="noopener noreferrer">
                                <i class="fas fa-map"></i> Публичная кадастровая карта
                            </a>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Основная область -->
            <main class="content">
                <!-- Панель карты -->
                <div class="content-panel active" id="content-map">
                    <div id="map"></div>
                    
                    <!-- Панель инструментов карты -->
                    <div id="map-toolbar" class="map-toolbar">
                        <button class="btn btn-sm" id="btn-add-direction-map" title="Добавить направление (выберите 2 колодца)">
                            <i class="fas fa-project-diagram"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-well-map" title="Добавить колодец (кликните на карте)">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-stuff-well-map" title="Набить колодец (клик по направлению)">
                            <i class="fas fa-plus-square"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-marker-map" title="Добавить столбик (кликните на карте)">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-duct-cable-map" title="Добавить кабель в канализации (выбор каналов)">
                            <i class="fas fa-wave-square"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-duct-cable-shortest-map" title="Создать кабель в канализации по кратчайшему пути">
                            <i class="fas fa-bezier-curve"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-relocate-duct-cable-map" title="Переложить кабель в канализации">
                            <i class="fas fa-random"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-ground-cable-map" title="Добавить кабель в грунте (ломаная линия)">
                            <i class="fas fa-route"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-aerial-cable-map" title="Добавить воздушный кабель (ломаная линия)">
                            <i class="fas fa-broadcast-tower"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-move-point-map" title="Переместить точечный объект">
                            <i class="fas fa-arrows-alt"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-toggle-owner-legend" title="Легенда по собственникам">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-map-defaults" title="Настройки по умолчанию">
                            <i class="fas fa-sliders-h"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-tu-mode" title="Режим ТУ">
                            <i class="fas fa-clipboard-list"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-inventory-mode" title="Режим инвентаризация">
                            <i class="fas fa-clipboard-check"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-refresh-map" title="Обновить карту">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <!-- Панель подсветки кабеля -->
                    <div id="highlight-bar" class="highlight-bar hidden">
                        <button class="btn btn-sm btn-secondary" id="btn-clear-highlight" title="Отменить подсветку">
                            <i class="fas fa-times"></i> Отменить подсветку
                        </button>
                    </div>
                    
                    <!-- Статус режима добавления -->
                    <div id="add-mode-status" class="add-mode-status hidden">
                        <span id="add-mode-text"></span>
                        <button class="btn btn-sm btn-primary hidden" id="btn-finish-add-mode">
                            <i class="fas fa-check"></i> Создать
                        </button>
                        <button class="btn btn-sm btn-danger" id="btn-cancel-add-mode">
                            <i class="fas fa-times"></i> Отмена
                        </button>
                    </div>
                    
                    <!-- Панель информации об объекте -->
                    <div id="object-info-panel" class="info-panel hidden">
                        <div class="info-panel-header">
                            <h4 id="info-title">Информация об объекте</h4>
                            <button class="btn-close" id="btn-close-info">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="info-content"></div>
                        <div class="info-panel-actions">
                            <button class="btn btn-primary btn-sm" id="btn-edit-object">
                                <i class="fas fa-edit"></i> Редактировать
                            </button>
                            <button class="btn btn-secondary btn-sm hidden" id="btn-copy-coords" title="Скопировать координаты">
                                <i class="fas fa-copy"></i> Копировать координаты
                            </button>
                            <button class="btn btn-danger btn-sm" id="btn-delete-object">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        </div>
                    </div>

                    <!-- Координаты курсора -->
                    <div id="cursor-coordinates">
                        <span id="coords-wgs84"></span>
                    </div>
                </div>

                <!-- Панель объектов -->
                <div class="content-panel" id="content-objects">
                    <div class="panel-header">
                        <h2>Объекты</h2>
                        <div class="panel-actions">
                            <button class="btn btn-primary" id="btn-add-object">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                            <button class="btn btn-secondary hidden" id="btn-recalc-inventory-unaccounted" title="Пересчитать неучтенные кабели (Инвентаризация)">
                                <i class="fas fa-sync-alt"></i> Пересчитать неучтенные
                            </button>
                            <button class="btn btn-secondary" id="btn-find-clones" title="Найти колодцы с одинаковыми координатами (WGS84)">
                                <i class="fas fa-clone"></i> Найти клоны
                            </button>
                            <button class="btn btn-danger hidden" id="btn-delete-selected">
                                <i class="fas fa-trash"></i> Удалить выбранные
                            </button>
                            <button class="btn btn-secondary" id="btn-import">
                                <i class="fas fa-upload"></i> Загрузить
                            </button>
                            <button class="btn btn-secondary" id="btn-export">
                                <i class="fas fa-download"></i> Выгрузить
                            </button>
                            <button class="btn btn-secondary hidden" id="btn-recalc-cable-lengths" title="Пересчитать длины кабелей в канализации по маршрутам">
                                <i class="fas fa-ruler-combined"></i> Пересчитать длины
                            </button>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" data-tab="wells">Колодцы</button>
                        <button class="tab" data-tab="directions">Направления</button>
                        <button class="tab" data-tab="channels">Каналы</button>
                        <button class="tab" data-tab="markers">Столбики</button>
                        <button class="tab" data-tab="unified_cables">Кабели</button>
                        <button class="tab" data-tab="groups">ТУ</button>
                    </div>

                    <!-- Фильтры для вкладки "Кабели" -->
                    <div class="filters-row hidden" id="cables-filters-row">
                        <select id="cables-filter-object-type">
                            <option value="">Вид объекта: все</option>
                        </select>
                        <select id="cables-filter-owner">
                            <option value="">Собственник: все</option>
                        </select>
                        <select id="cables-filter-contract">
                            <option value="">Контракт: все</option>
                        </select>
                        <div class="cables-totals">
                            <span>Количество: <strong id="cables-count">0</strong></span>
                            <span>Всего Длина расч. (м): <strong id="cables-length-sum">0</strong></span>
                        </div>
                    </div>
                    
                    <!-- Фильтры для остальных вкладок объектов -->
                    <div class="filters-row hidden" id="objects-filters-row">
                        <select id="objects-filter-type">
                            <option value="">Вид объекта: все</option>
                        </select>
                        <select id="objects-filter-owner">
                            <option value="">Собственник: все</option>
                        </select>
                        <div id="wells-extra-filters" style="display:none; flex-direction:column; gap:6px;">
                            <label id="wells-only-inventory-wrap" class="text-secondary" style="display:flex; align-items:center; gap:8px; white-space:nowrap;">
                                <input type="checkbox" id="wells-filter-has-inventory">
                                <span>Колодцы только с инвентаризационной карточкой</span>
                            </label>
                            <label id="wells-only-coords-refine-wrap" class="text-secondary" style="display:flex; align-items:center; gap:8px; white-space:nowrap;">
                                <input type="checkbox" id="wells-filter-coords-needs-refine">
                                <span>Колодцы требующие уточнения координат</span>
                            </label>
                        </div>
                        <div class="objects-totals" id="objects-totals" style="margin-left:auto; display:flex; gap:14px; flex-wrap:wrap; align-items:center; color: var(--text-secondary);">
                        </div>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="search-objects" placeholder="Поиск объектов...">
                        <i class="fas fa-search"></i>
                    </div>
                    
                    <div class="table-container">
                        <table id="objects-table">
                            <thead>
                                <tr id="table-header"></tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                    
                    <div class="pagination" id="pagination"></div>
                </div>

                <!-- Панель инцидентов -->
                <div class="content-panel" id="content-incidents">
                    <div class="panel-header">
                        <h2>Инциденты</h2>
                        <div class="panel-actions">
                            <button class="btn btn-primary" id="btn-add-incident">
                                <i class="fas fa-plus"></i> Создать инцидент
                            </button>
                        </div>
                    </div>
                    
                    <div class="filters-row">
                        <select id="incident-status-filter">
                            <option value="">Все статусы</option>
                            <option value="open">Открытые</option>
                            <option value="in_progress">В работе</option>
                            <option value="resolved">Решённые</option>
                        </select>
                        <input type="date" id="incident-date-from" placeholder="Дата с">
                        <input type="date" id="incident-date-to" placeholder="Дата по">
                        <button class="btn btn-primary" id="btn-filter-incidents">
                            <i class="fas fa-filter"></i> Фильтр
                        </button>
                    </div>
                    
                    <div class="incidents-list" id="incidents-list"></div>
                </div>

                <!-- Панель контрактов (отдельно от справочников) -->
                <div class="content-panel" id="content-contracts">
                    <div class="panel-header">
                        <h2>Контракты</h2>
                        <div class="panel-actions">
                            <button class="btn btn-primary" id="btn-add-contract">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="contracts-table">
                            <thead><tr id="contracts-table-header"></tr></thead>
                            <tbody id="contracts-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Панель отчётов -->
                <div class="content-panel" id="content-reports">
                    <div class="panel-header">
                        <h2>Отчёты</h2>
                    </div>
                    
                    <div class="reports-grid">
                        <div class="report-card" data-report="objects">
                            <i class="fas fa-database"></i>
                            <h3>Отчёт по объектам</h3>
                            <p>Статистика по всем объектам системы</p>
                        </div>
                        <div class="report-card" data-report="contracts">
                            <i class="fas fa-file-contract"></i>
                            <h3>Отчёт по контрактам</h3>
                            <p>Кабели и объекты по контрактам</p>
                        </div>
                        <div class="report-card" data-report="owners">
                            <i class="fas fa-building"></i>
                            <h3>Отчёт по собственникам</h3>
                            <p>Объекты в разрезе собственников</p>
                        </div>
                        <div class="report-card" data-report="incidents">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Отчёт по инцидентам</h3>
                            <p>Статистика инцидентов</p>
                        </div>
                        <div class="report-card" data-report="inventory">
                            <i class="fas fa-clipboard-check"></i>
                            <h3>Отчёт по инвентаризации</h3>
                            <p>Направления, обнаруженные кабели и неучтённые</p>
                        </div>
                    </div>
                    
                    <div id="report-content" class="hidden"></div>
                </div>

                <!-- Панель справочников -->
                <div class="content-panel" id="content-references">
                    <div class="panel-header">
                        <h2>Справочники</h2>
                    </div>
                    
                    <div class="references-grid">
                        <div class="reference-card" data-ref="object_types">
                            <i class="fas fa-shapes"></i>
                            <h3>Виды объектов</h3>
                        </div>
                        <div class="reference-card" data-ref="object_kinds">
                            <i class="fas fa-tags"></i>
                            <h3>Типы объектов</h3>
                        </div>
                        <div class="reference-card" data-ref="object_status">
                            <i class="fas fa-flag"></i>
                            <h3>Состояния</h3>
                        </div>
                        <div class="reference-card" data-ref="owners">
                            <i class="fas fa-building"></i>
                            <h3>Собственники</h3>
                        </div>
                        <div class="reference-card" data-ref="cable_types">
                            <i class="fas fa-network-wired"></i>
                            <h3>Типы кабелей</h3>
                        </div>
                        <div class="reference-card" data-ref="cable_catalog">
                            <i class="fas fa-ethernet"></i>
                            <h3>Каталог кабелей</h3>
                        </div>
                    </div>
                    
                    <div id="reference-content" class="hidden">
                        <div class="panel-header">
                            <h3 id="ref-title"></h3>
                            <div class="panel-actions">
                                <button class="btn btn-primary btn-sm" id="btn-add-ref">
                                    <i class="fas fa-plus"></i> Добавить
                                </button>
                                <button class="btn btn-secondary btn-sm" id="btn-back-refs">
                                    <i class="fas fa-arrow-left"></i> Назад
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="ref-table">
                                <thead><tr id="ref-table-header"></tr></thead>
                                <tbody id="ref-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Панель администрирования -->
                <div class="content-panel" id="content-admin">
                    <div class="panel-header">
                        <h2>Администрирование</h2>
                    </div>
                    
                    <div class="admin-section">
                        <h3><i class="fas fa-users"></i> Пользователи</h3>
                        <button class="btn btn-primary" id="btn-add-user">
                            <i class="fas fa-user-plus"></i> Добавить пользователя
                        </button>
                        <div class="table-container">
                            <table id="users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Логин</th>
                                        <th>Имя</th>
                                        <th>Email</th>
                                        <th>Роль</th>
                                        <th>Собственник</th>
                                        <th>Активен</th>
                                        <th>Последний вход</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <h3><i class="fas fa-history"></i> Журнал действий</h3>
                        <div id="audit-log"></div>
                    </div>
                </div>

                <!-- Панель настроек -->
                <div class="content-panel" id="content-settings">
                    <div class="panel-header">
                        <h2>Настройки</h2>
                        <div class="panel-actions">
                            <button class="btn btn-primary" id="btn-save-settings">
                                <i class="fas fa-save"></i> Сохранить
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <form id="settings-form" style="max-width: 720px;">
                            <h3 style="margin: 0 0 10px 0;">Настройка данных ГИС</h3>
                            <div class="form-group">
                                <label>Зум карты по умолчанию</label>
                                <input type="number" id="settings-map-zoom" min="1" max="22" step="1">
                            </div>
                            <div class="form-group">
                                <label>Координаты WGS84 по умолчанию — Широта</label>
                                <input type="number" id="settings-map-lat" step="0.000001">
                            </div>
                            <div class="form-group">
                                <label>Координаты WGS84 по умолчанию — Долгота</label>
                                <input type="number" id="settings-map-lng" step="0.000001">
                            </div>
                            <div class="form-group">
                                <label>Учитываемая длина кабеля в колодце (м)</label>
                                <input type="number" id="settings-cable-well-len" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Начало нумерации Объектов колодец вводной</label>
                                <input type="number" id="settings-input-well-number-start" step="1" min="1" placeholder="Напр.: 1000">
                                <p class="text-muted">Используется для автоматической нумерации колодцев типа "Ввод в здание".</p>
                            </div>

                            <hr style="margin: 18px 0;">
                            <h3 style="margin: 0 0 10px 0;">Настройка интерфейса карты ГИС</h3>
                            <div class="form-group">
                                <label>Толщина линий — Направление</label>
                                <input type="number" id="settings-line-weight-direction" step="0.1" min="0.5" placeholder="Напр.: 3">
                            </div>
                            <div class="form-group">
                                <label>Толщина линий — Кабель</label>
                                <input type="number" id="settings-line-weight-cable" step="0.1" min="0.5" placeholder="Напр.: 2">
                            </div>
                            <div class="form-group">
                                <label>Размер иконки — Колодец/Столбик</label>
                                <input type="number" id="settings-icon-size-well-marker" step="1" min="6" placeholder="Напр.: 24">
                                <p class="text-muted">Размер в пикселях. Применяется к колодцам (круг/квадрат) и столбикам.</p>
                            </div>
                            <div class="form-group">
                                <label>Размер шрифта — номер Колодца</label>
                                <input type="number" id="settings-font-size-well-number" step="1" min="8" placeholder="Напр.: 12">
                            </div>
                            <div class="form-group">
                                <label>Размер шрифта — длина Направления</label>
                                <input type="number" id="settings-font-size-direction-length" step="1" min="8" placeholder="Напр.: 12">
                            </div>
                            <div class="form-group">
                                <label>Код — точка ввода (Тип объекта колодца)</label>
                                <select id="settings-well-entry-kind-code">
                                    <option value="">Не задано</option>
                                </select>
                                <p class="text-muted">Выбор из справочника "Типы объектов" только для вида объекта "Колодец".</p>
                            </div>

                            <hr style="margin: 18px 0;">
                            <h3 style="margin: 0 0 10px 0;">Настройка ссылок меню</h3>
                            <div class="form-group">
                                <label>Ссылка на Ресурс для пересчёта координат</label>
                                <input type="url" id="settings-url-geoproj" placeholder="https://wgs-msk.soilbox.app/">
                            </div>
                            <div class="form-group">
                                <label>Ссылка на Публичную кадастровую карту</label>
                                <input type="url" id="settings-url-cadastre" placeholder="https://nspd.gov.ru/...">
                            </div>

                            <hr style="margin: 18px 0;">
                            <h3 style="margin: 0 0 10px 0;">Настройка слоя WMTS</h3>
                            <div class="form-group">
                                <label>URL шаблон</label>
                                <input type="url" id="settings-wmts-url-template">
                                <p class="text-muted">Поддерживаемые плейсхолдеры: <strong>{Style}</strong>, <strong>{TileMatrixSet}</strong>, <strong>{TileMatrix}</strong>, <strong>{TileRow}</strong>, <strong>{TileCol}</strong>.</p>
                            </div>
                            <div class="form-group">
                                <label>{Style}</label>
                                <input type="text" id="settings-wmts-style">
                            </div>
                            <div class="form-group">
                                <label>{TileMatrixSet}</label>
                                <input type="text" id="settings-wmts-tilematrixset">
                            </div>
                            <div class="form-group">
                                <label>{TileMatrix}</label>
                                <input type="text" id="settings-wmts-tilematrix">
                                <p class="text-muted">Обычно это <strong>{z}</strong> для GoogleMapsCompatible.</p>
                            </div>
                            <div class="form-group">
                                <label>{TileRow}</label>
                                <input type="text" id="settings-wmts-tilerow">
                                <p class="text-muted">Обычно это <strong>{y}</strong>.</p>
                            </div>
                            <div class="form-group">
                                <label>{TileCol}</label>
                                <input type="text" id="settings-wmts-tilecol">
                                <p class="text-muted">Обычно это <strong>{x}</strong>.</p>
                            </div>

                            <hr style="margin: 18px 0;">
                            <h3 style="margin: 0 0 10px 0;">Hotkey (Alt + клавиша) для панели инструментов карты</h3>
                            <p class="text-muted" style="margin-top: 0;">Укажите одну цифру или латинскую букву. Пример: <strong>A</strong> означает горячую клавишу <strong>Alt + A</strong>. Оставьте пустым, чтобы отключить.</p>

                            <div class="form-group">
                                <label>Добавить направление (выберите 2 колодца)</label>
                                <input type="text" id="settings-hotkey-add-direction" maxlength="1" placeholder="Напр.: D">
                            </div>
                            <div class="form-group">
                                <label>Добавить колодец (кликните на карте)</label>
                                <input type="text" id="settings-hotkey-add-well" maxlength="1" placeholder="Напр.: W">
                            </div>
                            <div class="form-group">
                                <label>Добавить столбик (кликните на карте)</label>
                                <input type="text" id="settings-hotkey-add-marker" maxlength="1" placeholder="Напр.: M">
                            </div>
                            <div class="form-group">
                                <label>Добавить кабель в канализации (выбор каналов)</label>
                                <input type="text" id="settings-hotkey-add-duct-cable" maxlength="1" placeholder="Напр.: C">
                            </div>
                            <div class="form-group">
                                <label>Добавить кабель в грунте (ломаная линия)</label>
                                <input type="text" id="settings-hotkey-add-ground-cable" maxlength="1" placeholder="Напр.: G">
                            </div>
                            <div class="form-group">
                                <label>Добавить воздушный кабель (ломаная линия)</label>
                                <input type="text" id="settings-hotkey-add-aerial-cable" maxlength="1" placeholder="Напр.: A">
                            </div>
                            <p class="text-muted">Настройки применяются к карте и ссылкам в боковой панели.</p>

                            <hr style="margin: 18px 0;">
                            <div class="admin-only" id="db-backup-settings">
                                <h3 style="margin: 0 0 10px 0;">Бэкапирование СУБД</h3>
                                <p class="text-muted" style="margin-top: 0;">
                                    Доступно только для роли “Администратор”. Создание и восстановление могут занять несколько минут.
                                </p>

                                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom: 10px;">
                                    <button type="button" class="btn btn-secondary" id="btn-db-backup-refresh">
                                        <i class="fas fa-rotate"></i> Обновить список
                                    </button>
                                    <button type="button" class="btn btn-primary" id="btn-db-backup-create-now">
                                        <i class="fas fa-database"></i> Создать бэкап сейчас
                                    </button>
                                </div>

                                <div class="form-group" style="margin-bottom: 6px;">
                                    <label style="display:flex; align-items:center; gap:8px;">
                                        <input type="checkbox" id="db-backup-schedule-enabled">
                                        Регулярное бэкапирование (включить)
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>Периодичность (в часах)</label>
                                    <input type="number" id="db-backup-interval-hours" min="1" max="720" step="1" placeholder="Напр.: 24">
                                    <p class="text-muted">Рекомендуется настроить CRON/планировщик на сервере. В интерфейсе хранится только конфигурация.</p>
                                </div>
                                <div class="form-group">
                                    <label>Хранить последних бэкапов (шт)</label>
                                    <input type="number" id="db-backup-keep-count" min="1" max="365" step="1" placeholder="Напр.: 30">
                                    <p class="text-muted">Если задано — при создании нового бэкапа старые будут удаляться автоматически.</p>
                                </div>
                                <div class="form-group">
                                    <label>Последний запуск</label>
                                    <input type="text" id="db-backup-last-run" disabled style="background: var(--bg-tertiary);" value="-">
                                </div>
                                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom: 14px;">
                                    <button type="button" class="btn btn-secondary" id="btn-db-backup-run-tick" title="Проверить расписание и запустить бэкап, если пора">
                                        <i class="fas fa-clock"></i> Запустить по расписанию (проверка)
                                    </button>
                                    <button type="button" class="btn btn-primary" id="btn-db-backup-save-schedule">
                                        <i class="fas fa-save"></i> Сохранить расписание
                                    </button>
                                </div>

                                <div style="border:1px solid var(--border-color); border-radius:10px; padding: 10px 12px; margin-bottom: 14px;">
                                    <div style="font-weight:800; margin-bottom:8px;">Crontab (регулярный запуск на сервере)</div>
                                    <div class="text-muted" style="margin-bottom:8px;">
                                        Если на сервере доступен `crontab`, можно установить правило автоматически. Иначе — скопируйте команду и добавьте вручную.
                                    </div>
                                    <textarea id="db-backup-cron-line" rows="2" readonly style="width:100%; resize: vertical; background: var(--bg-tertiary); font-family: monospace; color: var(--text-primary);"></textarea>
                                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px;">
                                        <button type="button" class="btn btn-secondary" id="btn-db-backup-cron-copy">
                                            <i class="fas fa-copy"></i> Скопировать команду
                                        </button>
                                        <button type="button" class="btn btn-primary" id="btn-db-backup-cron-install">
                                            <i class="fas fa-check"></i> Установить в crontab
                                        </button>
                                        <button type="button" class="btn btn-danger" id="btn-db-backup-cron-remove">
                                            <i class="fas fa-trash"></i> Удалить из crontab
                                        </button>
                                        <span class="text-muted" id="db-backup-cron-status" style="margin-left:auto;"></span>
                                    </div>
                                </div>

                                <div style="border:1px solid var(--border-color); border-radius: 10px; overflow:hidden;">
                                    <div style="padding: 10px 12px; background: var(--bg-secondary); font-weight: 700;">
                                        Доступные бэкапы
                                    </div>
                                    <div id="db-backups-list" style="max-height: 45vh; overflow:auto; padding: 10px 12px;">
                                        <div class="text-muted">Загрузка...</div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Модальное окно -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button class="btn-close" id="btn-close-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="notifications"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Custom JS (версия для сброса кеша) -->
    <script src="assets/js/api.js?v=2.3.3"></script>
    <script src="assets/js/map.js?v=2.3.3"></script>
    <script src="assets/js/app.js?v=2.3.3"></script>
</body>
</html>
