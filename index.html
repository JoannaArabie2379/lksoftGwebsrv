<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ИГС lksoftGwebsrv</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Custom CSS (версия для сброса кеша) -->
    <link rel="stylesheet" href="assets/css/style.css?v=2.2.0" />
</head>
<body class="theme-dark">
    <!-- Экран загрузки -->
    <div id="loading-screen">
        <div class="loader">
            <i class="fas fa-globe fa-spin"></i>
            <p>Загрузка ИГС...</p>
        </div>
    </div>

    <!-- Экран авторизации -->
    <div id="login-screen" class="hidden">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-map-marked-alt"></i>
                <h1>ИГС lksoftGwebsrv</h1>
                <p>Информационная географическая система</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login">Логин</label>
                    <input type="text" id="login" name="login" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Пароль</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Войти
                </button>
                <div id="login-error" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <!-- Основное приложение -->
    <div id="app" class="hidden">
        <!-- Верхняя панель -->
        <header class="top-bar">
            <div class="logo">
                <i class="fas fa-map-marked-alt"></i>
                <span>ИГС lksoftGwebsrv</span>
            </div>
            <div class="top-bar-actions">
                <div class="coordinate-system-toggle">
                    <button id="btn-wgs84" class="btn btn-sm active" title="WGS84 (EPSG:4326)">WGS84</button>
                </div>
                <div class="theme-toggle">
                    <button id="btn-theme-dark" class="btn btn-sm active" title="Тёмная тема">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="btn-theme-grey" class="btn btn-sm" title="Серая тема">
                        <i class="fas fa-adjust"></i>
                    </button>
                </div>
                <div class="user-menu">
                    <span id="user-name"></span>
                    <button id="btn-logout" class="btn btn-sm" title="Выход">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="main-container">
            <!-- Боковая панель -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <button class="nav-item active" data-panel="map">
                        <i class="fas fa-map"></i>
                        <span>Карта</span>
                    </button>
                    <button class="nav-item" data-panel="objects">
                        <i class="fas fa-database"></i>
                        <span>Объекты</span>
                    </button>
                    <button class="nav-item" data-panel="incidents">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Инциденты</span>
                    </button>
                    <button class="nav-item" data-panel="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Отчёты</span>
                    </button>
                    <button class="nav-item" data-panel="references">
                        <i class="fas fa-book"></i>
                        <span>Справочники</span>
                    </button>
                    <button class="nav-item admin-only" data-panel="admin">
                        <i class="fas fa-cog"></i>
                        <span>Админ</span>
                    </button>
                </nav>

                <!-- Панель слоёв -->
                <div class="sidebar-panel" id="panel-layers">
                    <h3><i class="fas fa-layer-group"></i> Слои</h3>
                    <div class="layers-list">
                        <label class="layer-item">
                            <input type="checkbox" id="layer-wells" checked>
                            <span class="layer-icon" style="background: #fa00fa;"></span>
                            <span>Колодцы</span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-channels" checked>
                            <span class="layer-icon" style="background: #fa00fa;"></span>
                            <span>Направления каналов</span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-markers" checked>
                            <span class="layer-icon" style="background: #e67e22;"></span>
                            <span>Столбики</span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-ground-cables">
                            <span class="layer-icon" style="background: #551b1b;"></span>
                            <span>Кабели в грунте</span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-aerial-cables">
                            <span class="layer-icon" style="background: #009dff;"></span>
                            <span>Воздушные кабели</span>
                        </label>
                        <label class="layer-item">
                            <input type="checkbox" id="layer-duct-cables">
                            <span class="layer-icon" style="background: #00bd26;"></span>
                            <span>Кабели в канализации</span>
                        </label>
                    </div>

                    <h3><i class="fas fa-filter"></i> Фильтры</h3>
                    <div class="filters-panel">
                        <div class="form-group">
                            <label>Группа</label>
                            <select id="filter-group">
                                <option value="">Все объекты</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Собственник</label>
                            <select id="filter-owner">
                                <option value="">Все</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Состояние</label>
                            <select id="filter-status">
                                <option value="">Все</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Контракт</label>
                            <select id="filter-contract">
                                <option value="">Все</option>
                            </select>
                        </div>
                        <button id="btn-reset-filters" class="btn btn-secondary btn-block">
                            <i class="fas fa-times"></i> Сбросить
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Основная область -->
            <main class="content">
                <!-- Панель карты -->
                <div class="content-panel active" id="content-map">
                    <div id="map"></div>
                    
                    <!-- Панель инструментов карты -->
                    <div id="map-toolbar" class="map-toolbar">
                        <button class="btn btn-sm" id="btn-add-direction-map" title="Добавить направление (выберите 2 колодца)">
                            <i class="fas fa-project-diagram"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-well-map" title="Добавить колодец (кликните на карте)">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-ground-cable-map" title="Добавить кабель в грунте (ломаная линия)">
                            <i class="fas fa-wave-square"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-aerial-cable-map" title="Добавить воздушный кабель (ломаная линия)">
                            <i class="fas fa-broadcast-tower"></i>
                        </button>
                        <button class="btn btn-sm" id="btn-add-duct-cable-map" title="Добавить кабель в канализации (выбор каналов)">
                            <i class="fas fa-route"></i>
                        </button>
                        <button class="btn btn-sm active" id="btn-toggle-well-labels" title="Подсказки (номера колодцев)">
                            <i class="fas fa-tag"></i>
                        </button>
                    </div>

                    <!-- Панель подсветки кабеля -->
                    <div id="highlight-bar" class="highlight-bar hidden">
                        <button class="btn btn-sm btn-secondary" id="btn-clear-highlight" title="Отменить подсветку">
                            <i class="fas fa-times"></i> Отменить подсветку
                        </button>
                    </div>
                    
                    <!-- Статус режима добавления -->
                    <div id="add-mode-status" class="add-mode-status hidden">
                        <span id="add-mode-text"></span>
                        <button class="btn btn-sm btn-primary hidden" id="btn-finish-add-mode">
                            <i class="fas fa-check"></i> Создать
                        </button>
                        <button class="btn btn-sm btn-danger" id="btn-cancel-add-mode">
                            <i class="fas fa-times"></i> Отмена
                        </button>
                    </div>
                    
                    <!-- Панель информации об объекте -->
                    <div id="object-info-panel" class="info-panel hidden">
                        <div class="info-panel-header">
                            <h4 id="info-title">Информация об объекте</h4>
                            <button class="btn-close" id="btn-close-info">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="info-content"></div>
                        <div class="info-panel-actions">
                            <button class="btn btn-primary btn-sm" id="btn-edit-object">
                                <i class="fas fa-edit"></i> Редактировать
                            </button>
                            <button class="btn btn-secondary btn-sm hidden" id="btn-copy-coords" title="Скопировать координаты">
                                <i class="fas fa-copy"></i> Копировать координаты
                            </button>
                            <button class="btn btn-danger btn-sm" id="btn-delete-object">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        </div>
                    </div>

                    <!-- Координаты курсора -->
                    <div id="cursor-coordinates">
                        <span id="coords-wgs84"></span>
                        <span id="coords-msk86"></span>
                    </div>
                </div>

                <!-- Панель объектов -->
                <div class="content-panel" id="content-objects">
                    <div class="panel-header">
                        <h2>Объекты</h2>
                        <div class="panel-actions">
                            <button class="btn btn-primary" id="btn-add-object">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                            <button class="btn btn-secondary" id="btn-import">
                                <i class="fas fa-upload"></i> Загрузить
                            </button>
                            <button class="btn btn-secondary" id="btn-export">
                                <i class="fas fa-download"></i> Выгрузить
                            </button>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" data-tab="wells">Колодцы</button>
                        <button class="tab" data-tab="directions">Направления</button>
                        <button class="tab" data-tab="channels">Каналы</button>
                        <button class="tab" data-tab="markers">Столбики</button>
                        <button class="tab" data-tab="unified_cables">Кабели</button>
                        <button class="tab" data-tab="groups">Группы</button>
                    </div>

                    <!-- Фильтры для вкладки "Кабели" -->
                    <div class="filters-row hidden" id="cables-filters-row">
                        <select id="cables-filter-object-type">
                            <option value="">Вид объекта: все</option>
                        </select>
                        <select id="cables-filter-owner">
                            <option value="">Собственник: все</option>
                        </select>
                        <select id="cables-filter-contract">
                            <option value="">Контракт: все</option>
                        </select>
                        <div class="cables-totals">
                            <span>Количество: <strong id="cables-count">0</strong></span>
                            <span>Всего Длина расч. (м): <strong id="cables-length-sum">0</strong></span>
                        </div>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="search-objects" placeholder="Поиск объектов...">
                        <i class="fas fa-search"></i>
                    </div>
                    
                    <div class="table-container">
                        <table id="objects-table">
                            <thead>
                                <tr id="table-header"></tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                    
                    <div class="pagination" id="pagination"></div>
                </div>

                <!-- Панель инцидентов -->
                <div class="content-panel" id="content-incidents">
                    <div class="panel-header">
                        <h2>Инциденты</h2>
                        <div class="panel-actions">
                            <button class="btn btn-primary" id="btn-add-incident">
                                <i class="fas fa-plus"></i> Создать инцидент
                            </button>
                        </div>
                    </div>
                    
                    <div class="filters-row">
                        <select id="incident-status-filter">
                            <option value="">Все статусы</option>
                            <option value="open">Открытые</option>
                            <option value="in_progress">В работе</option>
                            <option value="resolved">Решённые</option>
                        </select>
                        <input type="date" id="incident-date-from" placeholder="Дата с">
                        <input type="date" id="incident-date-to" placeholder="Дата по">
                        <button class="btn btn-primary" id="btn-filter-incidents">
                            <i class="fas fa-filter"></i> Фильтр
                        </button>
                    </div>
                    
                    <div class="incidents-list" id="incidents-list"></div>
                </div>

                <!-- Панель отчётов -->
                <div class="content-panel" id="content-reports">
                    <div class="panel-header">
                        <h2>Отчёты</h2>
                    </div>
                    
                    <div class="reports-grid">
                        <div class="report-card" data-report="objects">
                            <i class="fas fa-database"></i>
                            <h3>Отчёт по объектам</h3>
                            <p>Статистика по всем объектам системы</p>
                        </div>
                        <div class="report-card" data-report="contracts">
                            <i class="fas fa-file-contract"></i>
                            <h3>Отчёт по контрактам</h3>
                            <p>Кабели и объекты по контрактам</p>
                        </div>
                        <div class="report-card" data-report="owners">
                            <i class="fas fa-building"></i>
                            <h3>Отчёт по собственникам</h3>
                            <p>Объекты в разрезе собственников</p>
                        </div>
                        <div class="report-card" data-report="incidents">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Отчёт по инцидентам</h3>
                            <p>Статистика инцидентов</p>
                        </div>
                    </div>
                    
                    <div id="report-content" class="hidden"></div>
                </div>

                <!-- Панель справочников -->
                <div class="content-panel" id="content-references">
                    <div class="panel-header">
                        <h2>Справочники</h2>
                    </div>
                    
                    <div class="references-grid">
                        <div class="reference-card" data-ref="object_types">
                            <i class="fas fa-shapes"></i>
                            <h3>Виды объектов</h3>
                        </div>
                        <div class="reference-card" data-ref="object_kinds">
                            <i class="fas fa-tags"></i>
                            <h3>Типы объектов</h3>
                        </div>
                        <div class="reference-card" data-ref="object_status">
                            <i class="fas fa-flag"></i>
                            <h3>Состояния</h3>
                        </div>
                        <div class="reference-card" data-ref="owners">
                            <i class="fas fa-building"></i>
                            <h3>Собственники</h3>
                        </div>
                        <div class="reference-card" data-ref="contracts">
                            <i class="fas fa-file-contract"></i>
                            <h3>Контракты</h3>
                        </div>
                        <div class="reference-card" data-ref="cable_types">
                            <i class="fas fa-network-wired"></i>
                            <h3>Типы кабелей</h3>
                        </div>
                        <div class="reference-card" data-ref="cable_catalog">
                            <i class="fas fa-ethernet"></i>
                            <h3>Каталог кабелей</h3>
                        </div>
                    </div>
                    
                    <div id="reference-content" class="hidden">
                        <div class="panel-header">
                            <h3 id="ref-title"></h3>
                            <div class="panel-actions">
                                <button class="btn btn-primary btn-sm" id="btn-add-ref">
                                    <i class="fas fa-plus"></i> Добавить
                                </button>
                                <button class="btn btn-secondary btn-sm" id="btn-back-refs">
                                    <i class="fas fa-arrow-left"></i> Назад
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="ref-table">
                                <thead><tr id="ref-table-header"></tr></thead>
                                <tbody id="ref-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Панель администрирования -->
                <div class="content-panel" id="content-admin">
                    <div class="panel-header">
                        <h2>Администрирование</h2>
                    </div>
                    
                    <div class="admin-section">
                        <h3><i class="fas fa-users"></i> Пользователи</h3>
                        <button class="btn btn-primary" id="btn-add-user">
                            <i class="fas fa-user-plus"></i> Добавить пользователя
                        </button>
                        <div class="table-container">
                            <table id="users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Логин</th>
                                        <th>Имя</th>
                                        <th>Email</th>
                                        <th>Роль</th>
                                        <th>Активен</th>
                                        <th>Последний вход</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <h3><i class="fas fa-history"></i> Журнал действий</h3>
                        <div id="audit-log"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Модальное окно -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button class="btn-close" id="btn-close-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="notifications"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Custom JS (версия для сброса кеша) -->
    <script src="assets/js/api.js?v=2.2.0"></script>
    <script src="assets/js/map.js?v=2.2.0"></script>
    <script src="assets/js/app.js?v=2.2.0"></script>
</body>
</html>
